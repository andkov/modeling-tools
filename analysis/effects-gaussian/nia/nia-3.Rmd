---
title: "FIESTA NIA: T1"
author: 
  - "Andriy Koval"
  - "Matthew Landals"  
date: "Last updated: `r Sys.Date()`"
output:
  html_document:
    keep_md: yes
    toc: yes
    toc_float: yes
    code_folding: show
    theme: cerulean
    highlight: zenburn
editor_options: 
  chunk_output_type: console
---

> This report documents the implementation of Net Impact Analysis in the context of the FIESTA project.

___Important Definitions___

> RDB Cohort: Individuals who have at least one record of engaging at least one of the following CSS programs: Income Support, Employability Assessment, Employment Services training. 

> Research Cohort: Individuals whose FIRST engagement of Income Support program took place (started and ended) between 2014-04-01 and 2019-03-31.

<!--  Set the working directory to the repository's base directory; this assumes the report is nested inside of two directories.-->
```{r, echo=F, message=F}
# cat("Working directory: ", getwd())
library(knitr)
opts_knit$set(root.dir='../../')  #Don't combine this call with any other chunk -especially one that uses file paths.
```

```{r set_options, echo=F}
report_render_start_time <- Sys.time()
# set options shared by all chunks
opts_chunk$set(
  results      = 'show',
  message      = FALSE,
  warning      = FALSE,
  comment      = NA,
  tidy         = FALSE,
  # dpi        = 400, # dots per inch,
  # out.width  = "650px", # pixels, this affects only the markdown, not the underlying png file.  The height will be scaled appropriately.
  fig.width    = 6, # inches
  fig.height   = 4, # inches
  fig.path     = 'figure-png-iso/' # where figures are stored
)
echo_chunks    <- FALSE #Toggle for debugging.
message_chunks <- FALSE #Toggle for debugging.
options(width=100) # number of characters to display in the output (dflt = 80)
ggplot2::theme_set(ggplot2::theme_bw()) # common theme for all graphs
read_chunk("./analysis/nia-3-cra/nia-3.R") #This allows knitr to call chunks tagged in the underlying *.R file.
```

# Environment

This section reviews the components of the working environment of the report. Non-technical readers are welcomed to skip. Come back if you need to understand the origins of custom functions, scripts, or data objects.


<details>
   <summary> Packages used <span class="glyphicon glyphicon-plus-sign"></span></summary>


Packages used in current report

```{r load-packages, message=message_chunks, echo=T, results="hide"}
```

</details>


<details>
   <summary> External scripts <span class="glyphicon glyphicon-plus-sign"></span></summary>


Collection of custom functions used in current repository (`sda-information-requests`)

```{r load-sources, message=message_chunks, echo=T, results="hide"}
```

</details>


<details>
   <summary> Global values <span class="glyphicon glyphicon-plus-sign"></span></summary>


Values used throughout the report.

```{r declare-globals, message=message_chunks, echo=T, results="hide"}
```

</details>


<details>
   <summary> Functions <span class="glyphicon glyphicon-plus-sign"></span></summary>


Custom functions defined for use in this report.

```{r declare-functions, message=message_chunks, echo=T, results="hide"}
```
</details>



# Data


```{r load-data, results='show', message=FALSE, cache = T, eval=T}
```

<details>
   <summary> Making of `ds_spell` <span class="glyphicon glyphicon-plus-sign"></span></summary>
   
```{r tweak-data,echo = T,results="hide", results='show', message=message_chunks}
```
</details>

<details>
   <summary> Initial data forms and illustrative cases <span class="glyphicon glyphicon-plus-sign"></span></summary>
```{r inspect-data, results='show', message=message_chunks,cache=T, class.source = "fold-show"}
```
</details>


<details>
   <summary> Making of data form`ds0` <span class="glyphicon glyphicon-plus-sign"></span></summary>
```{r tweak-data-0,echo = T, results='show', message=message_chunks}
```

```{r inspect-data-0,echo = T, results='show', message=message_chunks}
```
</details>

<details>
   <summary> Making of data form `ds1` <span class="glyphicon glyphicon-plus-sign"></span></summary>
```{r tweak-data-1,echo = T, results='show', message=message_chunks}
```
</details>

<details>
   <summary> Making of data form `ds2` <span class="glyphicon glyphicon-plus-sign"></span></summary>
```{r tweak-data-2,echo = T, results='show', message=message_chunks}
```

```{r inspect-data-2,echo = T, results='show', message=message_chunks}
```
</details>

Transformations local to this report are captured in `ds1` form, the source for the subsequent analysis.

We differentiate four broad classes of variables: **design**, **covariates**, **outcomes**, and **interventions**.

## Design

Person identifier and the dates of the first Income Support spell, which took place in its entirety in 2014-2019 fiscal years
```{r inspect-design, echo = T, results='show', message=message_chunks, class.source="fold-hide"}
```


## Outcomes
```{r inspect-outcomes, echo = T, results='show', message=message_chunks, class.source="fold-hide"}
```


## Covariates
```{r inspect-covariates, echo = T, results='show', message=message_chunks, class.source="fold-hide"}
```

```{r empirical-reference-group, echo = T, results='show', message=message_chunks, class.source="fold-hide"}
```




## Interventions
```{r inspect-intervention, echo = T, results='show', message=message_chunks, class.source="fold-hide"}
```

## Treatment levels

Our approach will involve isolating a given intervention (e.g. "Career Planning workshop") and then balancing the group using all other interventions and covariates.  To achieve this, we will be transforming the intervention in focus into a binary variable `tx` which then will be passed to a common analytic pipeline of net impact analysis. 



```{r make-treatment-function, echo = F, results='show', message=message_chunks}
```

```{r inspect-treatment, echo = T, results='show', message=message_chunks}
```


</details>

> 

# Variable List 

> Event variables - handle facts about what happened and when

- `person_oid` - unique person identifier  
- `date_start` - the first Income Support spell began on this date    
- `date_end` - the first Income Support spell ended on this date   
- `return1_date` - the date of the first return to Income Support  
- `spell_duration` - duration of the first IS spell in months
- `return1_12m`  - Did the client return to IS withing 12 months after leaving?
- `is_spell_count6` - total number of Income Support stints a person has to date (of data retrieval) 
- `program_class` - hierarchical (0|1|2|3) classification of events with respect to programs. Note, however, that all events in this table will be of `program_class0 == "IS"`, but more granular class will be more informative (e.g. ETW vs BTF)

> Demographic variable - handle facts about clients' characteristics at the start of the IS spell

Note: Some variables use several operationalization to anticipate more specific research questions (e.g. `gender2` includes levels `male`, `female`,  while `gender3` includes `male`, `female`,`gen x`)

- Gender (2,3)
- Age (3,5, year)
- Education (3,4) 
- Marital Status (2,3)
- Dependents (2,4, count)
- Disability Status (2,3)
- Ethnicity (3)
- Immigration Status (2)
- Region (2,3,7)


> Intervention variables - each type of intervention (e.g. Job Placement, Workshop NonCP, etc.) is represented in __four(4)__ columns, each storing specific measure  


- `count` - total number events of this type  
- `dur_total` - total duration (in days) of the intervention, summed across all events  
- `start` - the date of start of the earliest event   
- `end` - the date of end of the latest event   

# General Introduction

<mark> Q.01</mark> What is the goal of this report? 

> This report documents the derivation of weights that balance groups (Treatement vs No Treatment) with respect to demographic covariates and service engagement (intervention)


<mark>Q.02</mark>  How do we define our research cohort?

> Research cohort includes individuals whose FIRST engagement of Income Support program took place (started and ended) between 2014-04-01 and 2019-03-31.


<mark>Q.03</mark>  Some clients might have multiple spells of Income Support. Do we analyze them all?

> No. We only look at the FIRST spell of each person, regardless how many spells they would have had (to date)

<mark>Q.04</mark> How many individuals does research cohort include? 
```{r class.source="fold-hide"}
ds0 %>% summarize(person_count = n_distinct(person_oid) %>% scales::comma())
```



# Overview of the Balancing Procedure

Our research question asks:  

> Does engagement with [Career Planning workshops] shorten the duration of Income Support spell? Are clients who have taken [Career Planning workshops] less likely to return to Income Support within 12 months after exiting IS? Do clients who engaged [Career Planning workshops] report higher income than those without in the year after exiting from Income Support?

To evaluate this hypothesis, we construct a matched pair design by reducing imbalance in the empirical distributions on the pre-treatment confounders (covariates + interventions) between the treated and the control groups. This group matching procedure results in a data set that might have been produced by a fully blocked randomized experiment, allowing for causal inferences from observational data. 

We will proceed in the following steps: 

- Specify research design  
- Fit propensity score model  
- Evaluate model convergence  
- Assess group balance  
- Compute treatment effect  

For details on implementation, please consult  [*twang* package vigneette](https://cran.r-project.org/web/packages/twang/vignettes/twang.pdf)

# Tx = Career Planning Workshop

## Research Design

To specify *treatment* and *control* groups (the difference between which will measure the effect of the treatment) we isolate a single intervention (e.g. Career Planning Workshop) and use it to create a binary `tx` variable, which we use as group membership indicator:  

```{r research-design-1-1, echo = T, results='show', message=message_chunks}
ds2 %>% 
  filter(used_in_nia) %>% 
  create_treatement_binary("career_planning") %>% # replaces this column with a column `tx`
  group_by(tx) %>% 
  summarize(
    sample_size = n()
    ,outcome_mean = mean(income_total_delta,na.rm =T)
    ,.groups = "drop"
  )
```

The difference in outcomes between these two groups can be attributed to the presence of intervention and quantifies the effect of receiving the treatment in a randomized experiment.

Naturally, this interpretation will hold ONLY if we can successfully demonstrate that *treatment* and *control* groups are balanced with respect to pre-treatment confounders (covariates + intervention). In other words, balancing allows to eliminate group differences attributed to covariates and other interventions. Achieving group balance is the purpose of propensity score modeling with `twang::ps()`,  presented in the next section.

> ATE or ATT? 

`twang::ps()` distinguishes two so-called *estimands*: `ATE` and `ATT`, which serve different  purposes in a research design.

`ATE` - Average Treatment Effect (on everyone) =  `k - f`, where  
`k` =  what would have happened had EVERYONE received Tx  
`f` =  what would have happened had NOONE received Tx  

`ATT` - Average Treatment Effect on the Treated = `a - b `, where  
`a` = what actually happened to the TREATED group   
`b` = what would have happened if TREATED group did NOT receive Tx   

> This analysis is interested in estimating the effect on the treated groups, therefore we use `ATT` estimand in fitting the propensity score model.

However, note that `ATE` estimand offers a different approach for describing the effect of the intervention ("How much clients are missing in benefits by NOT having this intervention"). 

## Propensity Score Model

Let's examine group differences (treatment vs control) before balancing  

```{r rd1-initial-differences, echo = T, results='show', message=message_chunks}
```

Now we estimate the propensity score model 
```{r rd1-ps-model, echo = T, results='show', message=message_chunks}
```

The table below  summarizes the results of propensity score model fitting. When searching for optimal model solution, the gradient boosting algorithm is guided by a measure of group imbalance, preferring solutions with smallest values. The last column `iter` shows how many iterations (i.e. different combinations of covariates) it took to arrive at optimal model solution.

`twang` currently offers four different measures of group imbalance, one for each row in the table above (plus the original, unweighted table).  For example, here is a partial table for `es.mean.ATT` solution:

```{r rd1-diagnostics-1, echo = T, results='show', message=message_chunks}
```

For each predictor, the table lists means (in case of binary variables this becomes a prevalence rate) and standard deviations of treatment and control groups and the results of two statistical tests of group equivalence:   
- Parametric chi-square test (or t-test if continuous) of association    
- Non-parametric Kolmogrorov-Smirnov test       

We are particularly interested in two values that quantify group balance on each variable:       
- `std.eff.sz` - the measure of effect size (standardized), computed as  (meanTX - meanCT)/sdTX, **larger** values indicating **less** group balance     
- `ks` - KS test statistics, distributed similarly to Chi-Square, **larger** value indicate **less** balanced groups. 

The values of effect size (`std.eff.sz`) has the following interpretation:  

|Effect size|	d	|Reference|  
|---|---|---|  
|Very small	|0.01|	[9][9]|  
|Small	|0.20	|[8][8]|  
|Medium |	0.50|	[8][8]|  
|Large	|0.80|	[8][8]|  
|Very large	|1.20|	[9][9]|  
|Huge	|2.0	|[9][9]|  

The values of KS test (`ks`) measures the absolute distance between empirical distributions, behaves similarly to Chi-Square and has similar interpretation. 

[9]:http://digitalcommons.wayne.edu/jmasm/vol8/iss2/26/
[8]:https://books.google.ca/books?id=2v9zDAsLvA0C&pg=PP1&redir_esc=y#v=onepage&q&f=false


## Model convergence


```{r eval-convergence-1, echo = T, results='show', message=message_chunks}
```

## Group balance

```{r rd1-diagnostics-1, echo = T, results='show', message=message_chunks}
```

To better understand the relationship between summary and balance tables, let's verify how the values in the summary table are derived from the individual balance tables
```{r rd1-diagnostics-1b, echo = T, results='show', message=message_chunks}
```

We combine individual balance tables into a single data set `dbt`, which we now can use to evaluate group balance across all four metrics
```{r rd1-diagnostics-2, echo = T, results='show', message=message_chunks}
```

> NOTE
> `stop.methods` (e.g. `es.mean.ATT` , `ks.max.ATT`,etc.) indicate what measure of group imbalance was chosen to guide model selection, while *summary statistics* (e.g. `es.mean`, `ks.max`, etc.) indicate what aspect of distribution ( of `std.eff.sz` or `ks`) we chose as the summary of group imballance

For example, `es.mean` of `.2` on a given covariate indicates that the means of treatment and control groups on this variable differ by an average of `.2` standard deviations, which constitutes a **small** effect size[9][9], which in this case can be interpreted as the size of group imbalance (smaller = better) 

While `es.mean` measures and *average* effect size, it may be also useful to use `es.max` to enforce that ALL variables are balanced. (The speed of the army is the speed of its slowest horse. Horse = variable). 

Alternatively, we can conceive other useful summaries, as for example an alternative method for computing the *average*: instead of taking the absolute values, we square them to obtain an average distance from the mean. We call this value `standard_distance` to differentiate from `es.mean`: 

```{r rd1-diagnostics-3, echo = T, results='show', message=message_chunks}
```
To evaluate group balance visually, we graph these test statistics (i.e. `std.eff.sz` and `ks`)


```{r rd1-diagnostics-4, echo = T, results='show', message=message_chunks, fig.width = 11, fig.height=7}
```

##  Treatment effect

```{r treatment-effect-1a, echo = F, results='show', message=message_chunks}
```

```{r treatment-effect-1b, echo = F, results='show', message=message_chunks, fig.width =7,fig.height=6}
```

> Interpretation of Converted Odds/Estimates

- *Clients who receive treatment are .6% less likely to be employed at survey*
- *Clients who receive treatment report $2,190 more in total earnings after their income support spell as compared to before the spell*

> Interpretation of Net Impact

- *Engaging Career Planning Workshop anytime before completing one's Income Support spell is associated with $1,143 increase from pre-IS levels, compared to clients who did not have this intervention*


# All other interventions

Please see  Part II of this report to examine solution for all included interventions.


Session Information {#session-info}
===========================================================================

For the sake of documentation and reproducibility, the current report was rendered in the following environment.  Click the line below to expand.

<details>
  <summary>Environment <span class="glyphicon glyphicon-plus-sign"></span></summary>
```{r session-info, echo=FALSE}
if( requireNamespace("devtools", quietly = TRUE) ) {
  devtools::session_info()
} else {
  sessionInfo()
}
```
</details>

```{r session-duration, echo=FALSE}
report_render_duration_in_seconds <- round(as.numeric(difftime(Sys.time(), report_render_start_time, units="secs")))
```

Report rendered by `r Sys.info()["user"]` at `r strftime(Sys.time(), "%Y-%m-%d, %H:%M %z")` in `r report_render_duration_in_seconds` seconds.
